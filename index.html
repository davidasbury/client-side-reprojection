<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Client-side reprojection using WKT projection strings</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        background-color: #ffffff;
      }

      #loader {
        display: inline;
        z-index: 30;
        position: absolute;
        right: 45%;
        top: 45%;
      }

      #projectionDiv {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ffffff;
        padding: 10px;
      }

      #info {
        background-color: white;
        opacity: 0.75;
        color: black;
        font-size: 18pt;
        padding: 8px;
        visibility: hidden;
      }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.24/"></script>

    <script>
      require([
        "esri/views/MapView",
        "esri/Map",
        "esri/geometry/SpatialReference",
        "esri/layers/GeoJSONLayer",
        "esri/layers/FeatureLayer",
        "esri/layers/VectorTileLayer",
        "esri/layers/TileLayer",
        "esri/core/reactiveUtils",
        "esri/widgets/Legend"
      ], (
        MapView,
        Map,
        SpatialReference,
        GeoJSONLayer,
        FeatureLayer,
        VectorTileLayer,
        TileLayer,
        reactiveUtils,
        Legend
      ) => {
        let view;
        /************************************************************
         * Create loader 
         ************************************************************/
        const loadingDiv = document.getElementById("loader");
        /************************************************************
         * Create dropdown for projection selector
         ************************************************************/
        const wktSelect = document.getElementById("projectWKT"); 

        wktSelect.addEventListener("change", () => {
          loadingDiv.style.display = "inline";
        /************************************************************
         * Function runs when dropdown is changed
         ************************************************************/ 
        const layer1 = createLayer();
          layer1.load()
            .then(function(layer1) {
              // create a background layer    
              const layer2 = new FeatureLayer(
                    {
                      title:"Background countries",
                      url:"https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/World_Countries_Generalized_with_tiny_countries_as_squares_background/FeatureServer/1",
                      
                    }
                  );
                  createView(layer1, layer2);
                }
              )
            .catch(errback);
          });
        /************************************************************
        * Function runs on first load
         ************************************************************/ 
        const layer1 = createLayer();
          layer1.load()
            .then(function(layer1) {
              // create a background layer  
              const layer2 = new FeatureLayer(
                  {
                  title:"Background countries",
                  url:"https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/World_Countries_Generalized_with_tiny_countries_as_squares_background/FeatureServer/1"
                  }
                );
                createView(layer1, layer2);
            }
            )
            /************************************************************
             * Enable mouse-over on desktop and tap on mobile 
            ************************************************************/   
/*          .then(function(enableHighlightOnPointerMove){
                let highlight = null;
                let lastHighlight = null;

                function enableHighlightOnPointerMove(view) {
                    view.whenLayerView(layer).then(function(layerView) {
                    view.on("pointer-move", function(event) {
                      view.hitTest(event).then(function(response) {

                        lastHighlight = highlight;

                        // if a feature is returned, highlight it
                        // and display its attributes in the popup
                        // if no features are returned, then close the popup
                        var id = null;

                        if (response.results.length) {
                          var feature = response.results.filter(function(result) {
                            return result.graphic.layer1 === layer1;
                          })[0].graphic;

                          feature.popupTemplate = layer1.popupTemplate;
                          id = feature.attributes.OBJECTID;
                          highlight = layerView.highlight([id]);
                          var selectionId = view.popup.selectedFeature
                            ? view.popup.selectedFeature.attributes.OBJECTID
                            : null;

                          if (highlight && id !== selectionId) {
                            view.popup.open({
                              features: [feature]
                            });
                          }
                        } else {
                          if (view.popup.visible) {
                            view.popup.close();
                            view.popup.clear();
                          }
                        }

                        // remove the previous highlight
                        if (lastHighlight) {
                          lastHighlight.remove();
                          lastHighlight = null;
                        }
                      });
                    });
          //       });
                }
          })*/
            .catch(errback);
        
        /************************************************************
         * Create an operational layer
         ************************************************************/ 
        // create a GeoJSON Layer from a Feature Service
          function createLayer(){
              let countriesLayer = new GeoJSONLayer({
                title:"GeoJSON Countries",
                url:"https://services.arcgis.com/nzS0F0zdNLvs7nc8/ArcGIS/rest/services/World_Countries_Generalized_with_tiny_countries_as_squares_join/FeatureServer/26/query?where=1%3D1&outFields=*&returnGeometry=true&f=geojson",
                outFields: ["*"],
                popupTemplate: {
                  overwriteActions: "true",
                  title: "{COUNTRY}"
                },
                renderer: {
                  type: "simple", // autocasts as new SimpleRenderer()
                  symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: [240, 240, 240, 0.5],
                    outline: {
                      color: [150, 150, 150, 0.7],
                      width: 0.5
                    }
                 }
                }
              });
            return countriesLayer;
            }
        // create a VectorTile layer
 /*         function createLayer() {
            let countriesLayer = new VectorTileLayer({
              title:"VectorTile Countries",
              url:"https://jsapi.maps.arcgis.com/sharing/rest/content/items/75f4dfdff19e445395653121a95a85db/resources/styles/root.json"
//              portalItem: {  // autocasts as new PortalItem()
//                id: "22b18b8bda79476a8c2e76080381635a"
//              }
            });
            return countriesLayer;
          }*/
         // create a raster TileLayer
/*         function createLayer(){
          let countriesLayer = new TileLayer({
            title:"RasterTile Countries",
            url:"https://tiles.arcgis.com/tiles/nzS0F0zdNLvs7nc8/arcgis/rest/services/World_Countries_tiny_squares_raster_tiles/MapServer"
          });
          return countriesLayer;
         } */
         // create a FeatureLayer
 /*        console.log("MyURL =",wktSelect.url);
         function createLayer(){ 
          let countriesLayer = new FeatureLayer({
              title: "FeatureLayer Countries",
              url: "https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/World_Countries_Generalized_with_tiny_countries_as_squares_join/FeatureServer/26",
              outFields: ["*"],
              popupTemplate: {
                overwriteActions: "true",
                title: "{COUNTRY}"
              }
            }); 
          return countriesLayer;
         }*/
        /*************************************************************************
         * This function is called at first load and whenever the user selects a 
         * new projection from the projections drop down.
         * New view and map is created with the spatial reference that user chose.
         *************************************************************************/

        function createView(layer1, layer2) {
        /************************************************************
         * Creates a spatial reference from the dropdown options
         ************************************************************/ 
         const viewSpatialReference = new SpatialReference({
            wkt: wktSelect.value    
          });
          let centerPoint = {
            x: 0,
            y: 0,
            spatialReference: viewSpatialReference
          };

          if (view) {
            view.map.removeAll();
            view.container = null;
            view.map = null;
          }
        /************************************************************
         * Creates a MapView with a new map 
         *************************************************************/
        view = new MapView({
            container: "viewDiv",
            //creates a new Map
            map: new Map({
              layers: [layer2,layer1]
            }),
            //configure the popup
            popup: {
              dockEnabled: true,
              dockOptions: {
                breakpoint: false,
                buttonEnabled: false,
                position: "top-center"
              }
            },
            //configure selection highlight
            highlightOptions: {
              color: "#282828",
              fillOpacity: 0
            },
            spatialReference: viewSpatialReference,
            center: centerPoint,
            scale: 166418924
          });
        /************************************************************
         * Add a background graphic to display the outside edge of the graticule
         ************************************************************/
          view.graphics.add({
            symbol: {
              type: "simple-fill",
              color: [0,122,204,0.05],
              outline: {
                width: 0.3,
                color: [120, 120, 120, 1]
              }
            },
            geometry: {
              type: "extent",
              xmin: -180,
              xmax: 180,
              ymin: -90,
              ymax: 90,
              // This geometry automatically reprojects
              // when added to the view
              spatialReference: SpatialReference.WGS84
            }
          });
        /************************************************************
         * Show or hide the legend by uncommenting/commenting this line 
         ************************************************************/ 
//          view.ui.add(new Legend({ view: view, style: "card" }), "bottom-left"); 

        /************************************************************
         * Enable projection dropdown and stop displaying loader once layers load properly 
         ************************************************************/        
         view.whenLayerView(layer1).then((layerView) => {
            reactiveUtils.when(
                () => !layerView.updating, 
                () => {
              // enable the projection dropdown
              wktSelect.disabled = false;
              // stop displaying loader
              loadingDiv.style.display = "none";
                },
                {
                once: true
            });
          });
        }
        /************************************************************
         * Executes if data retrieval was unsuccessful.
         ************************************************************/
        function errback(error) {
          console.error("something went wrong. ", error);
        }
        /************************************************************
         * Prevents the user from opening the popup with click 
         ************************************************************/  
         function disablePopupOnClick(view) {
          view.on("click", function(event) {
            event.stopPropagation();
          });
          return view;
        } 
      });
    </script>
  </head>

  <body>
    <div id="viewDiv">
      <div id="loader">
        <img src="https://developers.arcgis.com/javascript/latest/sample-code/client-projection/live/loader.gif" />
      </div>
      <div id="projectionDiv" class="esri-widget">
        <p>Select a projection</p>
        <select id="projectWKT" class="esri-widget" disabled>
          <option value ='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",
                            GEOGCS["GCS_WGS_1984",
                              DATUM["D_WGS_1984",S
                                PHEROID["WGS_1984",6378137.0,298.257223563]],
                              PRIMEM["Greenwich",0.0],
                              UNIT["Degree",0.0174532925199433]],
                            PROJECTION["Mercator_Auxiliary_Sphere"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",0.0],
                            PARAMETER["Standard_Parallel_1",0.0],
                            PARAMETER["Auxiliary_Sphere_Type",0.0],
                            UNIT["Meter",1.0]]'
                            >Web Mercator</option>
          <option value='PROJCS["WGS_1984_Equal_Earth_Greenwich",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Equal_Earth"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",0.0],
                            UNIT["Meter",1.0]]' 
                          >Equal Earth Greenwich</option>
          <option value='PROJCS["Equal Earth (Bering Strait)",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Equal_Earth"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",11.5],
                            UNIT["Meter",1.0]]'
                          myvalue='0' y='0' url="https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/World_Countries_tiny_squares/FeatureServer/26" 
                          selected>Equal Earth (Bering Strait)</option>
          <option value='PROJCS["WGS_1984_Equal_Earth_Americas",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Equal_Earth"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",-90.0],
                            UNIT["Meter",1.0]]'
                          >Equal Earth Americas</option>
          <option value='PROJCS["WGS_1984_Equal_Asia_Pacific",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Equal_Earth"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",150.0],
                            UNIT["Meter",1.0]]'
                          >Equal Earth Asia-Pacific</option>
          <option value='PROJCS["World_Winkel_Tripel_NGS",
                          GEOGCS["GCS_WGS_198 4",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Winkel_Tripel"],
                            PARAMETER["False_Easting",0.0],
                            PARAMETER["False_Northing",0.0],
                            PARAMETER["Central_Meridian",0.0],
                            PARAMETER["Standard_Parallel_1",50.467],
                            UNIT["Meter",1.0]]'
                          >Winkel III</option>
          <option value='PROJCS["World_Goode_Homolosine_Land",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Goode_Homolosine"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Central_Meridian",0.0],
                          PARAMETER["Option",1.0],
                          UNIT["Meter",1.0]]'
                          >Goode Homolosine (Land)</option>
          <option value='PROJCS["World_Goode_Homolosine_Ocean",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Goode_Homolosine"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Central_Meridian",192.0],
                          PARAMETER["Option",2.0],
                          UNIT["Meter",1.0]]'
                          >Goode Homolosine (Ocean)</option>                          
          <option value='PROJCS["World_Fuller",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WG S_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Fuller"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Option", 0.0],
                          UNIT["Meter",1.0]]'
                          >World Fuller</option>
          <option value='PROJCS["WGS_1984_Spilhaus_Ocean_Map_in_Square",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Adams_Square_II"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Scale_Factor",1.0],
                          PARAMETER["Azimuth",40.17823482],
                          PARAMETER["Longitude_Of_Center",66.94970198],
                          PARAMETER["Latitude_Of_Center",-49.56371678],
                          PARAMETER["XY_Plane_Rotation",45.0],
                          UNIT["Meter",1.0]]'
                          >Spilhaus</option>
          <option value='PROJCS["World_Eckert_VI",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Eckert_VI"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Central_Meridian",0.0],
                          UNIT["Meter",1.0]]'
                          >World Eckert VI</option>
          <option value='PROJCS["World_Polyconic",
                          GEOGCS["GCS_WGS_1984",
                            DATUM["D_WGS_1984",
                              SPHEROID["WGS_1984",6378137.0,298.257223563]],
                            PRIMEM["Greenwich",0.0],
                            UNIT["Degree",0.0174532925199433]],
                          PROJECTION["Polyconic"],
                          PARAMETER["False_Easting",0.0],
                          PARAMETER["False_Northing",0.0],
                          PARAMETER["Central_Meridian",0.0],
                          PARAMETER["Latitude_Of_Origin",0.0],
                          UNIT["Meter",1.0]]'
                          >World Polyconic</option>
          <option value='PROJCS["World_Gall_Stereographic",
                          GEOGCS["GCS_WGS_1984",
                              DATUM["WGS_1984",
                                  SPHEROID["WGS_1984",6378137,298.257223563]],
                              PRIMEM["Greenwich",0],
                              UNIT["Degree",0.017453292519943295]],
                          PROJECTION["Gall_Stereographic"],
                          PARAMETER["False_Easting",0],
                          PARAMETER["False_Northing",0],
                          PARAMETER["Central_Meridian",0],
                          UNIT["Meter",1]]'
                          >World Gall Stereographic</option>
          <option value='PROJCS["World_Sinusoidal",
                          GEOGCS["GCS_WGS_1984",
                              DATUM["WGS_1984",
                                  SPHEROID["WGS_1984",6378137,298.257223563]],
                              PRIMEM["Greenwich",0],
                              UNIT["Degree",0.017453292519943295]],
                          PROJECTION["Sinusoidal"],
                          PARAMETER["False_Easting",0],
                          PARAMETER["False_Northing",0],
                          PARAMETER["Central_Meridian",0],
                          UNIT["Meter",1]]'
                          >World Sinusoidal</option>
          <option value='PROJCS["World_Loximuthal",
                          GEOGCS["GCS_WGS_1984",
                              DATUM["WGS_1984",
                                  SPHEROID["WGS_1984",6378137,298.257223563]],
                              PRIMEM["Greenwich",0],
                              UNIT["Degree",0.017453292519943295]],
                          PROJECTION["Loximuthal"],
                          PARAMETER["False_Easting",0],
                          PARAMETER["False_Northing",0],
                          PARAMETER["Central_Meridian",0],
                          PARAMETER["Central_Parallel",40],
                          UNIT["Meter",1]]'
                          >World Loximuthal</option>
          <option value='PROJCS["World_Bonne",
                          GEOGCS["GCS_WGS_1984",
                              DATUM["WGS_1984",
                                  SPHEROID["WGS_1984",6378137,298.257223563]],
                              PRIMEM["Greenwich",0],
                              UNIT["Degree",0.017453292519943295]],
                          PROJECTION["Bonne"],
                          PARAMETER["False_Easting",0],
                          PARAMETER["False_Northing",0],
                          PARAMETER["Central_Meridian",0],
                          PARAMETER["Standard_Parallel_1",60],
                          UNIT["Meter",1]]'
                          >World Bonne</option>
        </select>
      </div>
    </div>
  </body>

</html>
